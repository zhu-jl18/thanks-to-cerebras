function Nt(e,t={}){let{signal:o,persistent:n}=t;return o?.aborted?Promise.reject(o.reason):new Promise((r,a)=>{let s=()=>{clearTimeout(l),a(o?.reason)},l=setTimeout(()=>{o?.removeEventListener("abort",s),r()},e);if(o?.addEventListener("abort",s,{once:!0}),n===!1)try{Deno.unrefTimer(l)}catch(f){if(!(f instanceof ReferenceError))throw f;console.error("`persistent` option is only available in Deno")}})}var et="Server closed",xe=80,we=443,ve=5,St=1e3,yt=class{#n;#r;#a;#t=!1;#e=new Set;#s=new AbortController;#o=new Set;#i;constructor(t){this.#n=t.port,this.#r=t.hostname,this.#a=t.handler,this.#i=t.onError??function(o){return console.error(o),new Response("Internal Server Error",{status:500})}}async serve(t){if(this.#t)throw new Deno.errors.Http(et);this.#f(t);try{return await this.#u(t)}finally{this.#y(t);try{t.close()}catch{}}}async listenAndServe(){if(this.#t)throw new Deno.errors.Http(et);let t=Deno.listen({port:this.#n??xe,hostname:this.#r??"0.0.0.0",transport:"tcp"});return await this.serve(t)}async listenAndServeTls(t,o){if(this.#t)throw new Deno.errors.Http(et);let n=Deno.listenTls({port:this.#n??we,hostname:this.#r??"0.0.0.0",certFile:t,keyFile:o,transport:"tcp"});return await this.serve(n)}close(){if(this.#t)throw new Deno.errors.Http(et);this.#t=!0;for(let t of this.#e)try{t.close()}catch{}this.#e.clear(),this.#s.abort();for(let t of this.#o)this.#c(t);this.#o.clear()}get closed(){return this.#t}get addrs(){return Array.from(this.#e).map(t=>t.addr)}async#d(t,o){let n;try{if(n=await this.#a(t.request,o),n.bodyUsed&&n.body!==null)throw new TypeError("Response body already consumed.")}catch(r){n=await this.#i(r)}try{await t.respondWith(n)}catch{}}async#l(t,o){for(;!this.#t;){let n;try{n=await t.nextRequest()}catch{break}if(n===null)break;this.#d(n,o)}this.#c(t)}async#u(t){let o;for(;!this.#t;){let n;try{n=await t.accept()}catch(s){if(s instanceof Deno.errors.BadResource||s instanceof Deno.errors.InvalidData||s instanceof Deno.errors.UnexpectedEof||s instanceof Deno.errors.ConnectionReset||s instanceof Deno.errors.NotConnected){o?o*=2:o=ve,o>=St&&(o=St);try{await Nt(o,{signal:this.#s.signal})}catch(i){if(!(i instanceof DOMException&&i.name==="AbortError"))throw i}continue}throw s}o=void 0;let r;try{r=Deno.serveHttp(n)}catch{continue}this.#m(r);let a={localAddr:n.localAddr,remoteAddr:n.remoteAddr};this.#l(r,a)}}#c(t){this.#p(t);try{t.close()}catch{}}#f(t){this.#e.add(t)}#y(t){this.#e.delete(t)}#m(t){this.#o.add(t)}#p(t){this.#o.delete(t)}};function ke(e){return e==="0.0.0.0"?"localhost":e}async function Pt(e,t={}){let o=t.port??8e3;typeof o!="number"&&(o=Number(o));let n=t.hostname??"0.0.0.0",r=new yt({port:o,hostname:n,handler:e,onError:t.onError});t?.signal?.addEventListener("abort",()=>r.close(),{once:!0});let a=Deno.listen({port:o,hostname:n,transport:"tcp"}),s=r.serve(a);return o=r.addrs[0].port,"onListen"in t?t.onListen?.({port:o,hostname:n}):console.log(`Listening on http://${ke(n)}:${o}/`),await s}var B="https://api.cerebras.ai/v1/chat/completions",Kt="https://api.cerebras.ai/public/v1/models",R="cerebras-proxy",A=[R,"meta","config"],mt=[R,"meta","model_catalog"],F=[R,"keys","api"],$=[R,"keys","proxy"],pt=[R,"meta","admin_password"],W=[R,"auth","token"],_t=10,E=5,Lt=3,Ot=7*24*60*60*1e3,ot=12e3,Dt=6e4,C=15e3,j=1e3,U=6*60*60*1e3,Bt=8e3,ht=["gpt-oss-120b","qwen-3-235b-a22b-instruct-2507","zai-glm-4.7"],Rt="qwen-3-235b-a22b-instruct-2507",Ft="cerebras-translator",K={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, GET, OPTIONS, DELETE, PUT","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Admin-Token"},_={"Cache-Control":"no-store, max-age=0",Pragma:"no-cache",Expires:"0"};function c(e,t={}){let o=new Headers({...K,..._,"Content-Type":"application/json"});return t.headers&&new Headers(t.headers).forEach((n,r)=>{o.set(r,n)}),new Response(JSON.stringify(e),{status:t.status??200,headers:o})}function L(e,t=400,o){return c({error:e},{status:t,headers:o})}function Ae(e){if(e>=500)return"\u670D\u52A1\u5668\u9519\u8BEF";switch(e){case 400:return"\u8BF7\u6C42\u9519\u8BEF";case 401:return"\u672A\u6388\u6743";case 403:return"\u7981\u6B62\u8BBF\u95EE";case 404:return"\u672A\u627E\u5230";case 409:return"\u51B2\u7A81";case 429:return"\u8BF7\u6C42\u8FC7\u591A";default:return"\u8BF7\u6C42\u5931\u8D25"}}function d(e,t={}){let o=t.status??400,n=new Headers({"Content-Type":"application/problem+json"});return t.headers&&new Headers(t.headers).forEach((r,a)=>{n.set(a,r)}),c({type:t.type??"about:blank",title:t.title??Ae(o),status:o,detail:e,...t.instance?{instance:t.instance}:{}},{status:o,headers:n})}var Ee=!!Deno.env.get("DENO_DEPLOYMENT_ID"),u=await(()=>{if(Ee)return Deno.openKv();let e=`${import.meta.dirname}/.deno-kv-local`;try{Deno.mkdirSync(e,{recursive:!0})}catch(t){if(!(t instanceof Deno.errors.AlreadyExists||typeof t=="object"&&t!==null&&"name"in t&&t.name==="AlreadyExists"))throw console.error("[KV] \u65E0\u6CD5\u521B\u5EFA\u672C\u5730 KV \u76EE\u5F55\uFF1A",t),t}return Deno.openKv(`${e}/kv.sqlite3`)})(),g=null;function nt(e){g=e}var m=new Map;function jt(e){m=e}var w=[];function Ut(e){w=e}var rt=0;function at(e){rt=e}var v=new Map,k=new Set,J=!1;function O(e){J=e}var gt=!1;function bt(e){gt=e}var b=[];function Ht(e){b=e}var st=0;function it(e){st=e}var ct=null;function zt(e){ct=e}var dt=null;function xt(e){dt=e}var p=new Map;function Vt(e){p=e}var I=new Set,lt=null;function Yt(e){lt=e}var Z=C;function Gt(e){Z=e}async function Xt(e,t){let o=t??crypto.getRandomValues(new Uint8Array(16)),n=new TextEncoder,r=await crypto.subtle.importKey("raw",n.encode(e),"PBKDF2",!1,["deriveBits"]),a=await crypto.subtle.deriveBits({name:"PBKDF2",salt:o.buffer,iterations:1e5,hash:"SHA-256"},r,32*8),s=new Uint8Array(a),i=btoa(String.fromCharCode(...o)),l=btoa(String.fromCharCode(...s));return`v1$pbkdf2$100000$${i}$${l}`}async function $t(e,t){let o=t.split("$");if(!(o.length===5&&o[0]==="v1"&&o[1]==="pbkdf2"))return!1;let n=Number.parseInt(o[2],10);if(!Number.isFinite(n)||n<=0)return!1;let r,a;try{r=Uint8Array.from(atob(o[3]),x=>x.charCodeAt(0)),a=Uint8Array.from(atob(o[4]),x=>x.charCodeAt(0))}catch{return!1}let s=new TextEncoder,i=await crypto.subtle.importKey("raw",s.encode(e),"PBKDF2",!1,["deriveBits"]),l=await crypto.subtle.deriveBits({name:"PBKDF2",salt:r.buffer,iterations:n,hash:"SHA-256"},i,a.length*8),f=new Uint8Array(l);if(f.length!==a.length)return!1;let h=0;for(let x=0;x<f.length;x++)h|=f[x]^a[x];return h===0}async function ut(){return(await u.get(pt)).value}async function Wt(e){let t=await Xt(e);await u.set(pt,t)}async function Jt(e){let t=await ut();return t?await $t(e,t):!1}async function wt(){let e=crypto.randomUUID(),t=Date.now()+Ot;return await u.set([...W,e],t),e}async function vt(e){if(!e)return!1;let t=await u.get([...W,e]);return t.value?Date.now()>t.value?(await u.delete([...W,e]),!1):!0:!1}async function Zt(e){await u.delete([...W,e])}async function Qt(e){let t=e.headers.get("X-Admin-Token");return await vt(t)}function qt(e){if(p.size===0)return{authorized:!0};let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return{authorized:!1};let o=t.substring(7).trim();for(let[n,r]of p)if(r.key===o)return{authorized:!0,keyId:n};return{authorized:!1}}function te(e){let t=p.get(e);t&&(t.useCount++,t.lastUsed=Date.now(),I.add(e))}function ee(){let e=crypto.getRandomValues(new Uint8Array(24));return"cpk_"+btoa(String.fromCharCode(...e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function kt(){return crypto.randomUUID()}function M(e){return e.length<=8?"*".repeat(e.length):e.substring(0,4)+"*".repeat(e.length-8)+e.substring(e.length-4)}function oe(e){return e.split(/[\n,\s]+/).map(t=>t.trim()).filter(t=>t.length>0)}function y(e){return e instanceof Error?e.message:String(e)}function H(e){return e instanceof DOMException||typeof e=="object"&&e!==null&&"name"in e?e.name==="AbortError":!1}async function T(e,t,o){let n=new AbortController,r=t.signal;r&&(r.aborted?n.abort():r.addEventListener("abort",()=>n.abort(),{once:!0}));let a=setTimeout(()=>n.abort(),Math.max(0,o));try{return await fetch(e,{...t,signal:n.signal})}finally{clearTimeout(a)}}function z(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function Q(e){return Number.isFinite(e)?Math.max(j,Math.trunc(e)):C}function V(){let e=Array.from(m.values());if(e.sort((t,o)=>t.createdAt-o.createdAt||t.id.localeCompare(o.id)),Ut(e.filter(t=>t.status==="active").map(t=>t.id)),w.length===0){at(0);return}at(rt%w.length)}function ne(e){if(w.length===0)return null;for(let t=0;t<w.length;t++){let o=(rt+t)%w.length,n=w[o];if((v.get(n)??0)>e)continue;let a=m.get(n);if(!(!a||a.status!=="active"))return at((o+1)%w.length),a.useCount+=1,a.lastUsed=e,k.add(n),g&&(g.totalRequests+=1,O(!0)),{key:a.key,id:n}}return null}function re(e,t){let o=t.headers.get("retry-after")?.trim(),n=o&&/^\d+$/.test(o)?Number.parseInt(o,10)*1e3:2e3;v.set(e,Date.now()+Math.max(0,n))}function ae(e){let t=m.get(e);t&&t.status!=="invalid"&&(t.status="invalid",k.add(e),v.delete(e),V())}function Y(e){let t=Array.isArray(e)?e:[],o=new Set,n=[];for(let r of t){let a=typeof r=="string"?r.trim():"";a&&(o.has(a)||(o.add(a),n.push(a)))}return n}function N(e){let t=e.toLowerCase();return t.includes("model_not_found")||t.includes("model not found")||t.includes("no such model")}function G(e){if(!e||typeof e!="object"||!("error"in e))return!1;let t=e.error;if(typeof t=="string")return N(t);if(!t||typeof t!="object")return!1;if(t.code==="model_not_found"||t.type==="model_not_found")return!0;let r=t.message;return typeof r=="string"?N(r):!1}function se(){if(b.length===0)return null;let e=st%b.length,t=b[e];return it((e+1)%b.length),g&&(g.currentModelIndex=st,O(!0)),t}function q(){if(Ht(Y(g?.modelPool)),b.length>0){let e=g?.currentModelIndex??0;it(e%b.length);return}it(0)}function At(e){let t=e?.kvFlushIntervalMs??C;return Q(t)}function ft(e){Gt(At(e)),lt!==null&&clearInterval(lt),Yt(setInterval(Ce,Z))}async function Ce(){let e=Date.now();for(let[r,a]of v)a<e&&v.delete(r);if(gt||!J&&k.size===0&&I.size===0||!g)return;bt(!0);let t=Array.from(k);k.clear();let o=Array.from(I);I.clear();let n=J;O(!1);try{let r=[];for(let a of t){let s=m.get(a);s&&r.push(u.set([...F,a],s))}for(let a of o){let s=p.get(a);s&&r.push(u.set([...$,a],s))}n&&r.push(u.set(A,g)),await Promise.all(r)}catch(r){for(let a of t)k.add(a);for(let a of o)I.add(a);O(J||n),console.error("[KV] flush failed:",r)}finally{bt(!1)}}async function ie(){nt(await S());let e=await D();jt(new Map(e.map(o=>[o.id,o]))),V(),q();let t=await Ie();Vt(new Map(t.map(o=>[o.id,o])))}async function ce(){let e=await u.get(A);if(!e.value){let i={modelPool:[...ht],currentModelIndex:0,totalRequests:0,kvFlushIntervalMs:C,schemaVersion:"5.0"};await u.set(A,i),e=await u.get(A)}if(!e.value)throw new Error("KV \u914D\u7F6E\u521D\u59CB\u5316\u5931\u8D25");let t=e.value,o=Array.isArray(t.modelPool)?Y(t.modelPool):[...ht],n=typeof t.currentModelIndex=="number"&&Number.isFinite(t.currentModelIndex)&&t.currentModelIndex>=0?Math.trunc(t.currentModelIndex):0,r=typeof t.totalRequests=="number"&&Number.isFinite(t.totalRequests)&&t.totalRequests>=0?Math.trunc(t.totalRequests):0,a=typeof t.kvFlushIntervalMs=="number"&&Number.isFinite(t.kvFlushIntervalMs)?t.kvFlushIntervalMs:C;if(t.schemaVersion!=="5.0"||"disabledModels"in t){let i={modelPool:o,currentModelIndex:n,totalRequests:r,kvFlushIntervalMs:a,schemaVersion:"5.0"};await u.set(A,i),e=await u.get(A)}if(!e.value)throw new Error("KV \u914D\u7F6E\u521D\u59CB\u5316\u5931\u8D25");return e}async function S(){return(await ce()).value}async function tt(e){for(let t=0;t<_t;t++){let o=await ce(),n=await e(o.value);if(n===o.value)return nt(o.value),o.value;if((await u.atomic().check(o).set(A,n).commit()).ok)return nt(n),n}throw new Error("\u914D\u7F6E\u66F4\u65B0\u5931\u8D25\uFF1A\u8FBE\u5230\u6700\u5927\u91CD\u8BD5\u6B21\u6570")}function Et(e,t){return t>=e.fetchedAt&&t-e.fetchedAt<U}async function Ct(){return(await u.get(mt)).value??null}async function It(){if(dt)return await dt;let e=(async()=>{let t=await T(Kt,{method:"GET",headers:{Accept:"application/json"}},Bt);if(!t.ok){let l=await t.text().catch(()=>""),f=l&&l.length<=200?`: ${l}`:"";throw new Error(`\u6A21\u578B\u76EE\u5F55\u62C9\u53D6\u5931\u8D25\uFF1AHTTP ${t.status}${f}`)}let n=(await t.json().catch(()=>({})))?.data,r=Array.isArray(n)?n.map(l=>{if(!l||typeof l!="object"||!("id"in l))return"";let f=l.id;return typeof f=="string"?f.trim():""}).filter(l=>l.length>0):[],a=new Set,s=[];for(let l of r)a.has(l)||(a.add(l),s.push(l));let i={source:"cerebras-public",fetchedAt:Date.now(),models:s};zt(i);try{await u.set(mt,i)}catch(l){console.error("[KV] model catalog save failed:",l)}return i})().finally(()=>{xt(null)});return xt(e),await e}async function X(e,t){let o=e.trim();if(!o)return;let n=b.includes(o);await tt(r=>{let a=Y(r.modelPool),s=a.filter(i=>i!==o);return s.length===a.length?r:{...r,modelPool:s,currentModelIndex:0,schemaVersion:"5.0"}}),q(),n&&console.warn(`[MODEL] removed (${t}): ${o}`)}async function D(){let e=[],t=u.list({prefix:F});for await(let o of t)e.push(o.value);return e}async function Mt(e){if(Array.from(m.values()).find(a=>a.key===e))return{success:!1,error:"\u5BC6\u94A5\u5DF2\u5B58\u5728"};let n=kt(),r={id:n,key:e,useCount:0,status:"active",createdAt:Date.now()};return await u.set([...F,n],r),m.set(n,r),V(),{success:!0,id:n}}async function de(e){let t=[...F,e];return(await u.get(t)).value?(await u.delete(t),m.delete(e),v.delete(e),k.delete(e),V(),{success:!0}):{success:!1,error:"\u5BC6\u94A5\u4E0D\u5B58\u5728"}}async function P(e,t){let o=[...F,e],n=m.get(e)??(await u.get(o)).value;if(!n)return;let r={...n,...t};await u.set(o,r),m.set(e,r),V()}async function Ie(){let e=[],t=u.list({prefix:$});for await(let o of t)e.push(o.value);return e}async function le(e){if(p.size>=E)return{success:!1,error:`\u6700\u591A\u53EA\u80FD\u521B\u5EFA ${E} \u4E2A\u4EE3\u7406\u5BC6\u94A5`};let t=kt(),o=ee(),n={id:t,key:o,name:e||`\u5BC6\u94A5 ${p.size+1}`,useCount:0,createdAt:Date.now()};return await u.set([...$,t],n),p.set(t,n),{success:!0,id:t,key:o}}async function ue(e){let t=[...$,e];return(await u.get(t)).value?(await u.delete(t),p.delete(e),I.delete(e),{success:!0}):{success:!1,error:"\u5BC6\u94A5\u4E0D\u5B58\u5728"}}async function fe(e,t){if(!t.startsWith("/api/auth/"))return null;if(e.method==="GET"&&t==="/api/auth/status"){let o=await ut()!==null,n=e.headers.get("X-Admin-Token"),r=await vt(n);return c({hasPassword:o,isLoggedIn:r})}if(e.method==="POST"&&t==="/api/auth/setup"){if(await ut()!==null)return d("\u5BC6\u7801\u5DF2\u8BBE\u7F6E",{status:400,instance:t});try{let{password:n}=await e.json();if(!n||n.length<4)return d("\u5BC6\u7801\u81F3\u5C11 4 \u4F4D",{status:400,instance:t});await Wt(n);let r=await wt();return c({success:!0,token:r})}catch(n){return d(y(n),{status:400,instance:t})}}if(e.method==="POST"&&t==="/api/auth/login")try{let{password:o}=await e.json();if(!await Jt(o))return d("\u5BC6\u7801\u9519\u8BEF",{status:401,instance:t});let r=await wt();return c({success:!0,token:r})}catch(o){return d(y(o),{status:400,instance:t})}if(e.method==="POST"&&t==="/api/auth/logout"){let o=e.headers.get("X-Admin-Token");return o&&await Zt(o),c({success:!0})}return d("Not Found",{status:404,instance:t})}async function ye(e,t){if(e.method==="GET"&&t==="/api/proxy-keys"){let n=Array.from(p.values()).map(r=>({id:r.id,key:M(r.key),name:r.name,useCount:r.useCount,lastUsed:r.lastUsed,createdAt:r.createdAt}));return c({keys:n,maxKeys:E,authEnabled:p.size>0})}if(e.method==="POST"&&t==="/api/proxy-keys")try{let{name:o}=await e.json().catch(()=>({name:""})),n=await le(o);return n.success?c(n,{status:201}):d(n.error??"\u521B\u5EFA\u5931\u8D25",{status:400,instance:t})}catch(o){return d(y(o),{status:400,instance:t})}if(e.method==="DELETE"&&t.startsWith("/api/proxy-keys/")){let o=t.split("/").pop(),n=await ue(o);return n.success?c(n):d(n.error??"\u5220\u9664\u5931\u8D25",{status:n.error==="\u5BC6\u94A5\u4E0D\u5B58\u5728"?404:400,instance:t})}if(e.method==="GET"&&t.startsWith("/api/proxy-keys/")&&t.endsWith("/export")){let o=t.split("/")[3],n=p.get(o);return n?c({key:n.key}):d("\u5BC6\u94A5\u4E0D\u5B58\u5728",{status:404,instance:t})}return null}async function Me(e){let t=m.get(e);if(!t)return{success:!1,status:"invalid",error:"\u5BC6\u94A5\u4E0D\u5B58\u5728"};let o=b.length>0?b[0]:Rt;try{let n=await T(B,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.key}`},body:JSON.stringify({model:o,messages:[{role:"user",content:"test"}],max_tokens:1})},ot);if(n.ok)return await P(e,{status:"active"}),{success:!0,status:"active"};if(n.status===401||n.status===403)return await P(e,{status:"invalid"}),{success:!1,status:"invalid",error:`HTTP ${n.status}`};if(n.status===404){let a=await n.clone().text().catch(()=>""),s=z(a);if(G(s)||N(a))return await X(o,"model_not_found"),await P(e,{status:"active"}),{success:!0,status:"active"}}return await P(e,{status:"inactive"}),{success:!1,status:"inactive",error:`HTTP ${n.status}`}}catch(n){let r=H(n)?"\u8BF7\u6C42\u8D85\u65F6":y(n);return await P(e,{status:"inactive"}),{success:!1,status:"inactive",error:r}}}async function me(e,t){if(e.method==="GET"&&t==="/api/keys"){let n=(await D()).map(r=>({...r,key:M(r.key)}));return c({keys:n})}if(e.method==="POST"&&t==="/api/keys")try{let{key:o}=await e.json();if(!o)return d("\u5BC6\u94A5\u4E0D\u80FD\u4E3A\u7A7A",{status:400,instance:t});let n=await Mt(o);return n.success?c(n,{status:201}):d(n.error??"\u6DFB\u52A0\u5931\u8D25",{status:n.error==="\u5BC6\u94A5\u5DF2\u5B58\u5728"?409:400,instance:t})}catch(o){return d(y(o),{status:400,instance:t})}if(e.method==="POST"&&t==="/api/keys/batch")try{let o=e.headers.get("Content-Type")||"",n;if(o.includes("application/json")){let s=await e.json();n=s.input||(typeof s=="string"?s:"")}else n=await e.text();if(!n?.trim())return d("\u8F93\u5165\u4E0D\u80FD\u4E3A\u7A7A",{status:400,instance:t});let r=oe(n),a={success:[],failed:[]};for(let s of r){let i=await Mt(s);i.success?a.success.push(M(s)):a.failed.push({key:M(s),error:i.error||"\u672A\u77E5\u9519\u8BEF"})}return c({summary:{total:r.length,success:a.success.length,failed:a.failed.length},results:a})}catch(o){return d(y(o),{status:400,instance:t})}if(e.method==="GET"&&t==="/api/keys/export"){let n=Array.from(m.values()).map(r=>r.key);return c({keys:n})}if(e.method==="GET"&&t.startsWith("/api/keys/")&&t.endsWith("/export")){let o=t.split("/")[3],n=m.get(o);return n?c({key:n.key}):d("\u5BC6\u94A5\u4E0D\u5B58\u5728",{status:404,instance:t})}if(e.method==="DELETE"&&t.startsWith("/api/keys/")){let o=t.split("/").pop(),n=await de(o);return n.success?c(n):d(n.error??"\u5220\u9664\u5931\u8D25",{status:n.error==="\u5BC6\u94A5\u4E0D\u5B58\u5728"?404:400,instance:t})}if(e.method==="POST"&&t.startsWith("/api/keys/")&&t.endsWith("/test")){let o=t.split("/")[3],n=await Me(o);return c(n)}return null}async function pe(e,t){if(e.method==="GET"&&t==="/api/models/catalog"){let o=Date.now(),n=ct;if(!n||!Et(n,o)){let s=await Ct();s&&(n=s)}let r=!0,a;if(n&&Et(n,o))r=!1;else try{n=await It(),r=!1}catch(s){a=y(s),r=!0}return n?c({source:n.source,fetchedAt:n.fetchedAt,ttlMs:U,stale:r,...a?{lastError:a}:{},models:n.models}):d(a??"\u65E0\u6CD5\u83B7\u53D6\u6A21\u578B\u76EE\u5F55",{status:502,instance:t})}if(e.method==="POST"&&t==="/api/models/catalog/refresh"){let o=ct??await Ct();try{return o=await It(),c({source:o.source,fetchedAt:o.fetchedAt,ttlMs:U,stale:!1,models:o.models})}catch(n){let r=y(n);return o?c({source:o.source,fetchedAt:o.fetchedAt,ttlMs:U,stale:!0,lastError:r,models:o.models}):d(r,{status:502,instance:t})}}if(e.method==="GET"&&t==="/api/models"){let o=await S(),n=Y(o.modelPool);return c({models:n})}if(e.method==="PUT"&&t==="/api/models")try{let n=(await e.json().catch(()=>({}))).models;if(!Array.isArray(n))return d("models \u5FC5\u987B\u4E3A\u5B57\u7B26\u4E32\u6570\u7EC4",{status:400,instance:t});let r=new Set,a=n.map(s=>typeof s=="string"?s.trim():"").filter(s=>s.length>0).filter(s=>r.has(s)?!1:(r.add(s),!0));return a.length===0?d("\u6A21\u578B\u6C60\u4E0D\u80FD\u4E3A\u7A7A",{status:400,instance:t}):(await tt(s=>({...s,modelPool:a,currentModelIndex:0,schemaVersion:"5.0"})),q(),c({success:!0,models:a}))}catch(o){return d(y(o),{status:400,instance:t})}if(e.method==="POST"&&t.startsWith("/api/models/")&&t.endsWith("/test")){let n=t.split("/")[3];if(!n)return d("\u7F3A\u5C11\u6A21\u578B\u540D\u79F0",{status:400,instance:t});let r;try{r=decodeURIComponent(n)}catch{return d("\u6A21\u578B\u540D\u79F0 URL \u7F16\u7801\u975E\u6CD5",{status:400,instance:t})}let a=Array.from(m.values()).find(s=>s.status==="active");if(!a)return d("\u6CA1\u6709\u53EF\u7528\u7684 API \u5BC6\u94A5",{status:400,instance:t});try{let s=await T(B,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.key}`},body:JSON.stringify({model:r,messages:[{role:"user",content:"test"}],max_tokens:1})},ot);if(s.ok)return c({success:!0,status:"available"});if(s.status===404){let l=await s.clone().text().catch(()=>""),f=z(l);if(G(f)||N(l))return await X(r,"model_not_found"),c({success:!1,status:"model_not_found",error:"model_not_found"})}return(s.status===401||s.status===403)&&await P(a.id,{status:"invalid"}),c({success:!1,status:"unavailable",error:`HTTP ${s.status}`})}catch(s){let i=H(s)?"\u8BF7\u6C42\u8D85\u65F6":y(s);return c({success:!1,status:"error",error:i})}}return null}async function he(e,t){if(e.method==="GET"&&t==="/api/stats"){let[o,n]=await Promise.all([D(),S()]),r={totalKeys:o.length,activeKeys:o.filter(a=>a.status==="active").length,totalRequests:n.totalRequests,keyUsage:o.map(a=>({id:a.id,maskedKey:M(a.key),useCount:a.useCount,status:a.status}))};return c(r)}if(e.method==="PATCH"&&t==="/api/config")try{let n=(await e.json().catch(()=>({}))).kvFlushIntervalMs;if(typeof n!="number"||!Number.isFinite(n))return d("kvFlushIntervalMs \u5FC5\u987B\u4E3A\u6570\u5B57",{status:400,instance:t});let r=Q(n),a=await tt(s=>({...s,kvFlushIntervalMs:r}));return ft(a),c({success:!0,kvFlushIntervalMs:r,effectiveKvFlushIntervalMs:Z,kvFlushIntervalMinMs:j})}catch(o){return d(y(o),{status:400,instance:t})}if(e.method==="GET"&&t==="/api/config"){let o=await S(),n=Q(o.kvFlushIntervalMs??j),r=At({...o,kvFlushIntervalMs:n});return c({...o,kvFlushIntervalMs:n,effectiveKvFlushIntervalMs:r,kvFlushIntervalMinMs:j})}return null}function ge(e){let t=Math.floor(Date.now()/1e3);return c({object:"list",data:[{id:Ft,object:"model",created:t,owned_by:"cerebras"}]})}async function be(e){let t=qt(e);if(!t.authorized)return L("Unauthorized",401);t.keyId&&te(t.keyId);try{let o=await e.json(),n=ne(Date.now());if(!n){let a=Date.now(),s=w.map(f=>v.get(f)??0).filter(f=>f>a),i=s.length>0?Math.min(...s):0,l=i>a?Math.ceil((i-a)/1e3):0;return L("\u6CA1\u6709\u53EF\u7528\u7684 API \u5BC6\u94A5",w.length>0?429:500,l>0?{"Retry-After":String(l)}:void 0)}let r=null;for(let a=0;a<Lt;a++){let s=se();if(!s)return L("\u6CA1\u6709\u53EF\u7528\u7684\u6A21\u578B",503);o.model=s;let i;try{i=await T(B,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.key}`},body:JSON.stringify(o)},Dt)}catch(f){let h=H(f),x=h?"\u4E0A\u6E38\u8BF7\u6C42\u8D85\u65F6":y(f);return L(x,h?504:502)}if(i.status===404){let h=await i.clone().text().catch(()=>""),x=z(h);if(G(x)||N(h)){r={status:i.status,statusText:i.statusText,headers:new Headers(i.headers),bodyText:h},i.body?.cancel(),await X(s,"model_not_found");continue}}i.status===429&&re(n.id,i),(i.status===401||i.status===403)&&ae(n.id);let l=new Headers(i.headers);return Object.entries(K).forEach(([f,h])=>{l.set(f,h)}),Object.entries(_).forEach(([f,h])=>{l.set(f,h)}),new Response(i.body,{status:i.status,statusText:i.statusText,headers:l})}if(r){let a=new Headers(r.headers);return a.delete("content-encoding"),a.delete("content-length"),a.delete("transfer-encoding"),Object.entries(K).forEach(([s,i])=>{a.set(s,i)}),Object.entries(_).forEach(([s,i])=>{a.set(s,i)}),new Response(r.bodyText,{status:r.status,statusText:r.statusText,headers:a})}return L("\u6A21\u578B\u4E0D\u53EF\u7528",502)}catch(o){return L(y(o))}}async function Tt(){let[e,t]=await Promise.all([D(),S()]),o=p.size,n={totalKeys:e.length,activeKeys:e.filter(s=>s.status==="active").length,totalRequests:t.totalRequests,proxyAuthEnabled:o>0,proxyKeyCount:o},a=`<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cerebras Translator</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzA2YjZkNCIgZD0iTTIyIDRoLTkuNzdMMTEgLjM0YS41LjUgMCAwIDAtLjUtLjM0SDJhMiAyIDAgMCAwLTIgMnYxNmEyIDIgMCAwIDAgMiAyaDkuNjVMMTMgMjMuNjhhLjUuNSAwIDAgMCAuNDcuMzJIMjJhMiAyIDAgMCAwIDItMlY2YTIgMiAwIDAgMC0yLTJaTTcuNSAxNWE0LjUgNC41IDAgMSAxIDIuOTItNy45Mi41LjUgMCAxIDEtLjY1Ljc2QTMuNSAzLjUgMCAxIDAgMTEgMTFINy41YS41LjUgMCAwIDEgMC0xaDRhLjUuNSAwIDAgMSAuNS41QTQuNSA0LjUgMCAwIDEgNy41IDE1Wm0xMS45LTRhMTEuMjYgMTEuMjYgMCAwIDEtMS44NiAzLjI5IDYuNjcgNi42NyAwIDAgMS0xLjA3LTEuNDguNS41IDAgMCAwLS45My4zOCA4IDggMCAwIDAgMS4zNCAxLjg3IDguOSA4LjkgMCAwIDEtLjY1LjYyTDE0LjYyIDExWk0yMyAyMmExIDEgMCAwIDEtMSAxaC03LjRsMi43Ny0zLjE3YS40OS40OSAwIDAgMCAuMDktLjQ4bC0uOTEtMi42NmE5LjM2IDkuMzYgMCAwIDAgMS0uODljMSAxIDEuOTMgMS45MSAyLjEyIDIuMDhhLjUuNSAwIDAgMCAuNjgtLjc0IDQzLjQ4IDQzLjQ4IDAgMCAxLTIuMTMtMi4xIDExLjQ5IDExLjQ5IDAgMCAwIDIuMjItNGgxLjA2YS41LjUgMCAwIDAgMC0xSDE4VjkuNWEuNS41IDAgMCAwLTEgMHYuNWgtMi41YS40OS40OSAwIDAgMC0uMjEgMGwtMS43Mi01SDIyYTEgMSAwIDAgMSAxIDFaIi8+PC9zdmc+">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* ========== \u4EAE\u8272\u4E3B\u9898\uFF08\u9ED8\u8BA4\uFF09 ========== */
    body, body.light {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #1e293b;
      transition: background 0.3s, color 0.3s;
    }
    body .container, body.light .container { max-width: 600px; margin: 0 auto; }
    body .header, body.light .header { text-align: center; margin-bottom: 24px; position: relative; }
    body .logo, body.light .logo { width: 48px; height: 48px; margin: 0 auto 12px; filter: drop-shadow(0 0 16px rgba(6, 182, 212, 0.5)); }
    body h1, body.light h1 { font-size: 22px; font-weight: 600; color: #1e293b; margin-bottom: 4px; }
    body h1 span, body.light h1 span { background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    body .subtitle, body.light .subtitle { font-size: 13px; color: #64748b; }
    body .card, body.light .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(6, 182, 212, 0.15);
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }
    body .tabs, body.light .tabs { display: flex; border-bottom: 1px solid rgba(6, 182, 212, 0.15); background: rgba(248, 250, 252, 0.8); }
    body .tab, body.light .tab {
      flex: 1; padding: 12px 16px; text-align: center; font-size: 13px; font-weight: 500;
      color: #64748b; cursor: pointer; border: none; background: transparent;
      border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;
    }
    body .tab:hover, body.light .tab:hover { color: #475569; }
    body .tab.active, body.light .tab.active { color: #06b6d4; border-bottom-color: #06b6d4; background: rgba(6, 182, 212, 0.05); }
    body .tab-content, body.light .tab-content { display: none; padding: 20px; }
    body .tab-content.active, body.light .tab-content.active { display: block; }
    body .stats-row, body.light .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(6, 182, 212, 0.1); }
    body .stat-item, body.light .stat-item { text-align: center; padding: 10px; background: rgba(6, 182, 212, 0.06); border-radius: 8px; border: 1px solid rgba(6, 182, 212, 0.12); }
    body .stat-value, body.light .stat-value { font-size: 22px; font-weight: 600; background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    body .stat-label, body.light .stat-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
    body .form-group, body.light .form-group { margin-bottom: 14px; }
    body .form-group label, body.light .form-group label { display: block; margin-bottom: 4px; color: #475569; font-size: 12px; font-weight: 500; }
    body .form-control, body.light .form-control {
      width: 100%; padding: 10px 12px; background: rgba(248, 250, 252, 0.9); border: 1px solid rgba(6, 182, 212, 0.2);
      border-radius: 8px; font-size: 13px; color: #1e293b; font-family: 'Inter', sans-serif; transition: all 0.2s;
    }
    body .form-control::placeholder, body.light .form-control::placeholder { color: #94a3b8; }
    body .form-control:focus, body.light .form-control:focus { outline: none; border-color: #06b6d4; box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.15); }
    textarea.form-control { resize: vertical; min-height: 70px; }
    .btn {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: #fff; border: none;
      padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 500;
      transition: all 0.2s; font-family: 'Inter', sans-serif; box-shadow: 0 2px 8px rgba(6, 182, 212, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }
    .btn.is-loading {
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4); }
    body .btn-outline, body.light .btn-outline { background: transparent; color: #0891b2; border: 1px solid rgba(6, 182, 212, 0.4); box-shadow: none; }
    body .btn-outline:hover, body.light .btn-outline:hover { background: rgba(6, 182, 212, 0.08); transform: none; }
    body .btn-danger, body.light .btn-danger { background: transparent; color: #dc2626; border: 1px solid rgba(220, 38, 38, 0.4); box-shadow: none; }
    body .btn-danger:hover, body.light .btn-danger:hover { background: rgba(220, 38, 38, 0.08); transform: none; }
    body .btn-success, body.light .btn-success { background: transparent; color: #16a34a; border: 1px solid rgba(22, 163, 74, 0.4); box-shadow: none; }
    body .btn-success:hover, body.light .btn-success:hover { background: rgba(22, 163, 74, 0.08); transform: none; }
    body .divider, body.light .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.15), transparent); margin: 16px 0; }
    body .list-item, body.light .list-item {
      background: rgba(248, 250, 252, 0.8); border: 1px solid rgba(6, 182, 212, 0.1); border-radius: 8px;
      padding: 10px 12px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;
    }
    body .list-item:hover, body.light .list-item:hover { border-color: rgba(6, 182, 212, 0.2); background: rgba(255, 255, 255, 0.9); }
    .item-info { flex: 1; min-width: 0; }
    body .item-primary, body.light .item-primary { display: flex; align-items: center; gap: 6px; color: #334155; font-size: 11px; margin-bottom: 2px; flex-wrap: wrap; }
    .key-text { font-family: 'JetBrains Mono', monospace; word-break: break-all; }
    .key-actions { display: inline-flex; align-items: center; gap: 2px; flex-shrink: 0; }
    body .item-secondary, body.light .item-secondary { font-size: 10px; color: #64748b; display: flex; align-items: center; gap: 4px; }
    .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 500; text-transform: uppercase; }
    body .status-active, body.light .status-active { background: rgba(22, 163, 74, 0.12); color: #16a34a; }
    body .status-inactive, body.light .status-inactive { background: rgba(202, 138, 4, 0.12); color: #ca8a04; }
    body .status-invalid, body.light .status-invalid { background: rgba(220, 38, 38, 0.12); color: #dc2626; }
    .item-actions { display: flex; gap: 4px; flex-shrink: 0; margin-left: 10px; }
    .item-actions .btn { padding: 5px 8px; font-size: 10px; }
    body .btn-icon, body.light .btn-icon { background: none; border: none; padding: 4px; cursor: pointer; color: #64748b; transition: color 0.2s; display: inline-flex; align-items: center; justify-content: center; }
    body .btn-icon:hover, body.light .btn-icon:hover { color: #06b6d4; }
    body .notification, body.light .notification {
      position: fixed; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(8px);
      border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 8px; padding: 10px 16px; display: none; z-index: 10000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); font-size: 12px;
    }
    .notification.show { display: block; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    body .notification.success, body.light .notification.success { color: #16a34a; border-color: rgba(22, 163, 74, 0.3); }
    body .notification.error, body.light .notification.error { color: #dc2626; border-color: rgba(220, 38, 38, 0.3); }
    body .hint, body.light .hint { font-size: 11px; color: #64748b; margin-top: 10px; }
    body .empty-state, body.light .empty-state { text-align: center; padding: 20px; color: #64748b; font-size: 12px; }
    body .section-title, body.light .section-title { font-size: 12px; font-weight: 500; color: #475569; margin-bottom: 10px; }
    .auth-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; margin-left: 8px; }
    body .auth-on, body.light .auth-on { background: rgba(22, 163, 74, 0.12); color: #16a34a; }
    body .auth-off, body.light .auth-off { background: rgba(202, 138, 4, 0.12); color: #ca8a04; }
    body .footer, body.light .footer { text-align: center; margin-top: 20px; font-size: 11px; color: #64748b; }
    body .footer span, body.light .footer span { color: #06b6d4; }
    body #authOverlay, body.light #authOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    body .auth-card, body.light .auth-card {
      background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(6, 182, 212, 0.15);
      border-radius: 12px; padding: 32px; max-width: 340px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    body .auth-card h2, body.light .auth-card h2 { color: #1e293b; }

    /* ========== \u6697\u8272\u4E3B\u9898 ========== */
    body.dark {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0;
    }
    body.dark h1 { color: #f1f5f9; }
    body.dark .card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(6, 182, 212, 0.2);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }
    body.dark .tabs { background: rgba(15, 23, 42, 0.5); }
    body.dark .tab:hover { color: #94a3b8; }
    body.dark .stat-item { background: rgba(6, 182, 212, 0.08); border: 1px solid rgba(6, 182, 212, 0.15); }
    body.dark .form-group label { color: #94a3b8; }
    body.dark .form-control {
      background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(6, 182, 212, 0.25);
      color: #e2e8f0;
    }
    body.dark .form-control::placeholder { color: #475569; }
    body.dark .form-control:focus { box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2); }
    body.dark .btn-outline { color: #06b6d4; }
    body.dark .btn-outline:hover { background: rgba(6, 182, 212, 0.1); }
    body.dark .btn-danger { color: #f87171; border-color: rgba(248, 113, 113, 0.4); }
    body.dark .btn-danger:hover { background: rgba(248, 113, 113, 0.1); }
    body.dark .btn-success { color: #4ade80; border-color: rgba(74, 222, 128, 0.4); }
    body.dark .btn-success:hover { background: rgba(74, 222, 128, 0.1); }
    body.dark .divider { background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.2), transparent); }
    body.dark .list-item {
      background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(6, 182, 212, 0.1);
    }
    body.dark .list-item:hover { border-color: rgba(6, 182, 212, 0.25); background: rgba(15, 23, 42, 0.8); }
    body.dark .item-primary { color: #cbd5e1; }
    body.dark .status-active { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
    body.dark .status-inactive { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    body.dark .status-invalid { background: rgba(248, 113, 113, 0.15); color: #f87171; }
    body.dark .notification {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(6, 182, 212, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }
    body.dark .notification.success { color: #4ade80; border-color: rgba(74, 222, 128, 0.4); }
    body.dark .notification.error { color: #f87171; border-color: rgba(248, 113, 113, 0.4); }
    body.dark .section-title { color: #94a3b8; }
    body.dark .auth-on { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
    body.dark .auth-off { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    body.dark .footer { color: #475569; }
    body.dark #authOverlay {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    body.dark .auth-card {
      background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(6, 182, 212, 0.25);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    body.dark .auth-card h2 { color: #f1f5f9; }

    /* ========== \u4E3B\u9898\u5207\u6362\u6309\u94AE ========== */
    .theme-toggle {
      position: absolute; top: 0; right: 0;
      background: none; border: none; cursor: pointer; padding: 8px;
      color: #64748b; transition: color 0.2s;
    }
    .theme-toggle:hover { color: #06b6d4; }
    .theme-toggle svg { width: 20px; height: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="theme-toggle" onclick="toggleTheme()" title="\u5207\u6362\u4E3B\u9898">
        <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
      <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path fill="#06b6d4" d="M22 4h-9.77L11 .34a.5.5 0 0 0-.5-.34H2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h9.65L13 23.68a.5.5 0 0 0 .47.32H22a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2ZM7.5 15a4.5 4.5 0 1 1 2.92-7.92.5.5 0 1 1-.65.76A3.5 3.5 0 1 0 11 11H7.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 .5.5A4.5 4.5 0 0 1 7.5 15Zm11.9-4a11.26 11.26 0 0 1-1.86 3.29 6.67 6.67 0 0 1-1.07-1.48.5.5 0 0 0-.93.38 8 8 0 0 0 1.34 1.87 8.9 8.9 0 0 1-.65.62L14.62 11ZM23 22a1 1 0 0 1-1 1h-7.4l2.77-3.17a.49.49 0 0 0 .09-.48l-.91-2.66a9.36 9.36 0 0 0 1-.89c1 1 1.93 1.91 2.12 2.08a.5.5 0 0 0 .68-.74 43.48 43.48 0 0 1-2.13-2.1 11.49 11.49 0 0 0 2.22-4h1.06a.5.5 0 0 0 0-1H18V9.5a.5.5 0 0 0-1 0v.5h-2.5a.49.49 0 0 0-.21 0l-1.72-5H22a1 1 0 0 1 1 1Z"/>
        </svg>
      </div>
      <h1><span>Cerebras</span> Translator</h1>
      <p class="subtitle">\u57FA\u4E8E\u5927\u5584\u4EBA\u7684\u7FFB\u8BD1\u7528\u4E2D\u8F6C\u670D\u52A1</p>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('keys')">API \u5BC6\u94A5</button>
        <button class="tab" onclick="switchTab('models')">\u6A21\u578B\u914D\u7F6E</button>
        <button class="tab" onclick="switchTab('access')">\u8BBF\u95EE\u63A7\u5236</button>
      </div>

      <div id="keysTab" class="tab-content active">
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-value">${n.totalKeys}</div>
            <div class="stat-label">\u603B\u5BC6\u94A5</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${n.activeKeys}</div>
            <div class="stat-label">\u6D3B\u8DC3</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${n.totalRequests}</div>
            <div class="stat-label">\u8BF7\u6C42\u6570</div>
          </div>
        </div>

        <div class="form-group">
          <label>\u6DFB\u52A0 Cerebras API \u5BC6\u94A5</label>
          <input type="text" id="singleKey" class="form-control" placeholder="\u8F93\u5165 Cerebras API \u5BC6\u94A5">
          <button class="btn" onclick="addSingleKey()" style="margin-top: 8px;">\u6DFB\u52A0</button>
        </div>

        <div class="divider"></div>

        <div class="form-group">
          <label>\u6279\u91CF\u5BFC\u5165</label>
          <textarea id="batchKeys" class="form-control" placeholder="\u6BCF\u884C\u4E00\u4E2A\u5BC6\u94A5"></textarea>
          <button class="btn" onclick="addBatchKeys()" style="margin-top: 8px;">\u5BFC\u5165</button>
        </div>

        <div class="divider"></div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span class="section-title" style="margin: 0;">\u5BC6\u94A5\u5217\u8868</span>
          <button class="btn btn-outline" onclick="exportAllKeys()">\u5BFC\u51FA\u5168\u90E8</button>
        </div>
        <div id="keysContainer"></div>
      </div>

      <div id="modelsTab" class="tab-content">
        <p class="hint" style="margin-top: 0; margin-bottom: 14px;">\u6A21\u578B\u6C60\u8F6E\u8BE2\uFF0C\u5206\u6563 TPM \u8D1F\u8F7D</p>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <span class="section-title" style="margin: 0;">\u53EF\u7528\u6A21\u578B\u76EE\u5F55</span>
          <button class="btn btn-outline" onclick="refreshModelCatalog()" id="refreshModelCatalogBtn">\u5237\u65B0</button>
        </div>
        <p class="hint" id="modelCatalogHint" style="margin-top: 0;">\u52A0\u8F7D\u4E2D...</p>

        <div id="modelCatalogContainer"></div>
        <button class="btn" onclick="saveModelPoolFromSelection()" style="margin-top: 8px;" id="saveModelPoolBtn">\u4FDD\u5B58\u6A21\u578B\u6C60</button>
      </div>

      <div id="accessTab" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
          <div>
            <span class="section-title" style="margin: 0;">\u4EE3\u7406\u8BBF\u95EE\u5BC6\u94A5</span>
            <span id="authBadge" class="auth-badge ${n.proxyAuthEnabled?"auth-on":"auth-off"}">${n.proxyAuthEnabled?"\u9274\u6743\u5DF2\u5F00\u542F":"\u516C\u5F00\u8BBF\u95EE"}</span>
          </div>
          <span style="font-size: 11px; color: #64748b;" id="keyCountLabel">${n.proxyKeyCount}/${E}</span>
        </div>
        <p class="hint" style="margin-top: 0; margin-bottom: 14px;">\u521B\u5EFA\u5BC6\u94A5\u540E\u81EA\u52A8\u5F00\u542F\u9274\u6743\uFF1B\u5220\u9664\u6240\u6709\u5BC6\u94A5\u5219\u53D8\u4E3A\u516C\u5F00\u8BBF\u95EE</p>

        <div class="form-group">
          <label>\u5BC6\u94A5\u540D\u79F0\uFF08\u53EF\u9009\uFF09</label>
          <input type="text" id="proxyKeyName" class="form-control" placeholder="\u4F8B\u5982\uFF1A\u79FB\u52A8\u7AEF\u5E94\u7528">
          <button class="btn" onclick="createProxyKey()" style="margin-top: 8px;" id="createProxyKeyBtn">\u521B\u5EFA\u5BC6\u94A5</button>
        </div>

        <div class="divider"></div>
        <div class="section-title">\u5DF2\u521B\u5EFA\u7684\u5BC6\u94A5</div>
        <div id="proxyKeysContainer"></div>

        <div class="divider"></div>
        <div class="section-title">\u9AD8\u7EA7\u8BBE\u7F6E</div>
        <div class="form-group">
          <label>KV \u5237\u76D8\u95F4\u9694\uFF08ms\uFF09</label>
          <input type="number" id="kvFlushIntervalMs" class="form-control" min="1000" step="100" placeholder="\u4F8B\u5982 15000">
          <button class="btn btn-outline" onclick="saveKvFlushIntervalMs()" style="margin-top: 8px;">\u4FDD\u5B58</button>
          <p class="hint" id="kvFlushIntervalHint">\u6700\u5C0F 1000ms\u3002\u7528\u4E8E\u63A7\u5236\u7EDF\u8BA1/\u7528\u91CF\u5199\u56DE KV \u7684\u9891\u7387\u3002</p>
        </div>
      </div>
    </div>

    <div class="footer">Endpoint: <span>/v1/chat/completions</span></div>
    <div class="notification" id="notification"></div>
  </div>

  <div id="authOverlay">
    <div class="auth-card">
      <div style="text-align: center; margin-bottom: 20px;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 40px; height: 40px; margin-bottom: 8px; filter: drop-shadow(0 0 12px rgba(6, 182, 212, 0.5));">
          <path fill="#06b6d4" d="M22 4h-9.77L11 .34a.5.5 0 0 0-.5-.34H2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h9.65L13 23.68a.5.5 0 0 0 .47.32H22a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2ZM7.5 15a4.5 4.5 0 1 1 2.92-7.92.5.5 0 1 1-.65.76A3.5 3.5 0 1 0 11 11H7.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 .5.5A4.5 4.5 0 0 1 7.5 15Zm11.9-4a11.26 11.26 0 0 1-1.86 3.29 6.67 6.67 0 0 1-1.07-1.48.5.5 0 0 0-.93.38 8 8 0 0 0 1.34 1.87 8.9 8.9 0 0 1-.65.62L14.62 11ZM23 22a1 1 0 0 1-1 1h-7.4l2.77-3.17a.49.49 0 0 0 .09-.48l-.91-2.66a9.36 9.36 0 0 0 1-.89c1 1 1.93 1.91 2.12 2.08a.5.5 0 0 0 .68-.74 43.48 43.48 0 0 1-2.13-2.1 11.49 11.49 0 0 0 2.22-4h1.06a.5.5 0 0 0 0-1H18V9.5a.5.5 0 0 0-1 0v.5h-2.5a.49.49 0 0 0-.21 0l-1.72-5H22a1 1 0 0 1 1 1Z"/>
        </svg>
        <h2 style="color: #f1f5f9; font-size: 18px;"><span style="background: linear-gradient(135deg, #06b6d4, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Cerebras</span> Translator</h2>
      </div>
      <p id="authTitle" style="color: #94a3b8; font-size: 12px; text-align: center; margin-bottom: 20px;">\u52A0\u8F7D\u4E2D...</p>
      <div class="form-group">
        <label id="passwordLabel">\u5BC6\u7801</label>
        <input type="password" id="authPassword" class="form-control" placeholder="\u8F93\u5165\u5BC6\u7801">
      </div>
      <div id="confirmGroup" class="form-group" style="display: none;">
        <label>\u786E\u8BA4\u5BC6\u7801</label>
        <input type="password" id="authConfirm" class="form-control" placeholder="\u518D\u6B21\u8F93\u5165\u5BC6\u7801">
      </div>
      <button class="btn" id="authBtn" onclick="handleAuth()" style="width: 100%; padding: 10px; font-size: 13px;">\u63D0\u4EA4</button>
      <p id="authError" style="color: #f87171; font-size: 11px; text-align: center; margin-top: 10px; display: none;"></p>
    </div>
  </div>

  <script>
    let adminToken = localStorage.getItem('adminToken') || '';
    let authMode = 'login';
    const MAX_PROXY_KEYS = ${E};

    let currentModelPool = [];
    let modelCatalogState = null;

    // \u4E3B\u9898\u7BA1\u7406
    function loadTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.body.className = saved;
      updateThemeIcon();
    }

    function toggleTheme() {
      const current = document.body.classList.contains('dark') ? 'dark' : 'light';
      const next = current === 'dark' ? 'light' : 'dark';
      document.body.className = next;
      localStorage.setItem('theme', next);
      updateThemeIcon();
    }

    function updateThemeIcon() {
      const isDark = document.body.classList.contains('dark');
      document.getElementById('sunIcon').style.display = isDark ? 'none' : 'block';
      document.getElementById('moonIcon').style.display = isDark ? 'block' : 'none';
    }

    loadTheme();

    function getAuthHeaders() { return { 'X-Admin-Token': adminToken }; }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const tabs = ['keys', 'models', 'access'];
      const idx = tabs.indexOf(tab);
      if (idx >= 0) {
        document.querySelectorAll('.tab')[idx].classList.add('active');
        document.getElementById(tab + 'Tab').classList.add('active');
      }
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/status', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          showAuthError(getApiErrorMessage(res, data));
          return;
        }
        if (!data.hasPassword) {
          authMode = 'setup';
          document.getElementById('authTitle').textContent = '\u9996\u6B21\u4F7F\u7528\uFF0C\u8BF7\u8BBE\u7F6E\u7BA1\u7406\u5BC6\u7801';
          document.getElementById('passwordLabel').textContent = '\u65B0\u5BC6\u7801\uFF08\u81F3\u5C11 4 \u4F4D\uFF09';
          document.getElementById('confirmGroup').style.display = 'block';
          document.getElementById('authBtn').textContent = '\u8BBE\u7F6E\u5BC6\u7801';
          document.getElementById('authOverlay').style.display = 'flex';
        } else if (!data.isLoggedIn) {
          authMode = 'login';
          document.getElementById('authTitle').textContent = '\u8BF7\u767B\u5F55\u4EE5\u7EE7\u7EED';
          document.getElementById('passwordLabel').textContent = '\u5BC6\u7801';
          document.getElementById('confirmGroup').style.display = 'none';
          document.getElementById('authBtn').textContent = '\u767B\u5F55';
          document.getElementById('authOverlay').style.display = 'flex';
        } else {
          document.getElementById('authOverlay').style.display = 'none';
          loadProxyKeys();
          loadKeys();
          loadModelCatalog();
          loadModels();
          loadConfig();
        }
      } catch (e) { showAuthError('\u68C0\u67E5\u767B\u5F55\u72B6\u6001\u5931\u8D25'); }
    }

    function showAuthError(msg) {
      const el = document.getElementById('authError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    async function handleAuth() {
      const password = document.getElementById('authPassword').value;
      document.getElementById('authError').style.display = 'none';
      if (authMode === 'setup') {
        const confirm = document.getElementById('authConfirm').value;
        if (password.length < 4) { showAuthError('\u5BC6\u7801\u81F3\u5C11 4 \u4F4D'); return; }
        if (password !== confirm) { showAuthError('\u4E24\u6B21\u5BC6\u7801\u4E0D\u4E00\u81F4'); return; }
        try {
          const res = await fetch('/api/auth/setup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            showAuthError(getApiErrorMessage(res, data) || '\u8BBE\u7F6E\u5931\u8D25');
            return;
          }
          if (data.success && data.token) { adminToken = data.token; localStorage.setItem('adminToken', adminToken); checkAuth(); }
          else showAuthError('\u8BBE\u7F6E\u5931\u8D25');
        } catch (e) { showAuthError('\u9519\u8BEF: ' + formatClientError(e)); }
      } else {
        try {
          const res = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            showAuthError(getApiErrorMessage(res, data) || '\u767B\u5F55\u5931\u8D25');
            return;
          }
          if (data.success && data.token) { adminToken = data.token; localStorage.setItem('adminToken', adminToken); checkAuth(); }
          else showAuthError('\u767B\u5F55\u5931\u8D25');
        } catch (e) { showAuthError('\u9519\u8BEF: ' + formatClientError(e)); }
      }
    }

    document.getElementById('authPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { if (authMode === 'setup') document.getElementById('authConfirm').focus(); else handleAuth(); }
    });
    document.getElementById('authConfirm')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAuth(); });

    let notificationTimer = null;
    function showNotification(message, type = 'success') {
      const notif = document.getElementById('notification');
      if (!notif) { alert(message); return; }
      if (notificationTimer) {
        clearTimeout(notificationTimer);
        notificationTimer = null;
      }
      notif.textContent = message;
      notif.className = 'notification show ' + type;
      notif.style.display = 'block';
      notif.style.zIndex = '10000';
      notificationTimer = setTimeout(() => {
        notif.classList.remove('show');
        notif.style.display = 'none';
        notificationTimer = null;
      }, 3000);
    }

    function formatClientError(error) {
      if (!error) return '\u672A\u77E5\u9519\u8BEF';
      if (error.name === 'AbortError') return '\u8BF7\u6C42\u8D85\u65F6\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5';
      const msg = error.message || String(error);
      const lower = msg.toLowerCase();
      if (lower.includes('failed to fetch') || lower.includes('networkerror') || lower.includes('err_connection_refused')) {
        return '\u65E0\u6CD5\u8FDE\u63A5\u5230\u672C\u5730\u670D\u52A1\uFF08' + location.origin + '\uFF09\uFF0C\u8BF7\u786E\u8BA4 Deno \u670D\u52A1\u5728\u8FD0\u884C\u4E14\u7AEF\u53E3\u53EF\u8BBF\u95EE';
      }
      return msg;
    }

    async function fetchJsonWithTimeout(url, options, timeoutMs = 15000) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), Math.max(0, timeoutMs));
      try {
        const res = await fetch(url, { ...options, signal: controller.signal });
        const text = await res.text();
        let data = {};
        if (text) {
          try { data = JSON.parse(text); } catch { data = { raw: text }; }
        }
        return { res, data };
      } finally {
        clearTimeout(timeoutId);
      }
    }

    function getApiErrorMessage(res, data) {
      if (data && typeof data.detail === 'string' && data.detail.trim()) return data.detail;
      if (data && typeof data.error === 'string' && data.error.trim()) return data.error;
      if (data && typeof data.title === 'string' && data.title.trim()) return data.title;
      if (data && typeof data.message === 'string' && data.message.trim()) return data.message;
      return 'HTTP ' + res.status;
    }

    function handleUnauthorized(res) {
      if (res.status !== 401) return false;
      adminToken = '';
      localStorage.removeItem('adminToken');
      checkAuth();
      return true;
    }

    function setButtonLoading(btn, loading, text) {
      if (!btn) return;

      if (loading) {
        if (!('oldText' in btn.dataset)) {
          btn.dataset.oldText = btn.textContent || '';
        }

        const w = btn.getBoundingClientRect().width;
        if (Number.isFinite(w) && w > 0) {
          btn.dataset.oldWidth = String(w);
          btn.style.width = w + 'px';
        }

        btn.classList.add('is-loading');
        btn.textContent = text || '\u5904\u7406\u4E2D...';
        btn.disabled = true;
        return;
      }

      if ('oldText' in btn.dataset) {
        btn.textContent = btn.dataset.oldText || '';
      }

      delete btn.dataset.oldText;
      delete btn.dataset.oldWidth;
      btn.style.width = '';
      btn.classList.remove('is-loading');
      btn.disabled = false;
    }

    // \u914D\u7F6E\u7BA1\u7406
    async function loadConfig() {
      try {
        const res = await fetch('/api/config', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u52A0\u8F7D\u914D\u7F6E\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }

        const input = document.getElementById('kvFlushIntervalMs');
        if (input) {
          input.value = String(data.kvFlushIntervalMs ?? '');
          if (data.kvFlushIntervalMinMs) input.min = String(data.kvFlushIntervalMinMs);
        }

        const hint = document.getElementById('kvFlushIntervalHint');
        if (hint) {
          const effective = data.effectiveKvFlushIntervalMs ?? data.kvFlushIntervalMs;
          hint.textContent = '\u5F53\u524D\u751F\u6548\uFF1A' + String(effective ?? '') + 'ms';
        }
      } catch (e) {
        showNotification('\u52A0\u8F7D\u914D\u7F6E\u5931\u8D25: ' + formatClientError(e), 'error');
      }
    }

    async function saveKvFlushIntervalMs() {
      const el = document.getElementById('kvFlushIntervalMs');
      const raw = el ? el.value : '';
      const ms = Number(raw);
      const min = Number(el?.min || '1000');

      if (!Number.isFinite(ms)) {
        showNotification('\u8BF7\u8F93\u5165\u5408\u6CD5\u6570\u5B57', 'error');
        return;
      }
      if (ms < min) {
        showNotification('\u6700\u5C0F ' + String(min) + 'ms', 'error');
        return;
      }

      try {
        const res = await fetch('/api/config', {
          method: 'PATCH',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ kvFlushIntervalMs: ms }),
        });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u4FDD\u5B58\u5931\u8D25', 'error');
          return;
        }
        showNotification('\u5DF2\u4FDD\u5B58');
        loadConfig();
      } catch (e) {
        showNotification('\u4FDD\u5B58\u5931\u8D25: ' + formatClientError(e), 'error');
      }
    }

    // \u4EE3\u7406\u5BC6\u94A5\u7BA1\u7406
    async function loadProxyKeys() {
      try {
        const res = await fetch('/api/proxy-keys', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u52A0\u8F7D\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }

        const container = document.getElementById('proxyKeysContainer');
        const badge = document.getElementById('authBadge');
        const countLabel = document.getElementById('keyCountLabel');
        const createBtn = document.getElementById('createProxyKeyBtn');

        countLabel.textContent = (data.keys?.length || 0) + '/' + MAX_PROXY_KEYS;
        createBtn.disabled = (data.keys?.length || 0) >= MAX_PROXY_KEYS;

        if (data.authEnabled) {
          badge.className = 'auth-badge auth-on';
          badge.textContent = '\u9274\u6743\u5DF2\u5F00\u542F';
        } else {
          badge.className = 'auth-badge auth-off';
          badge.textContent = '\u516C\u5F00\u8BBF\u95EE';
        }

        if (data.keys?.length > 0) {
          container.textContent = '';

          for (const k of data.keys) {
            const item = document.createElement('div');
            item.className = 'list-item';

            const info = document.createElement('div');
            info.className = 'item-info';

            const primary = document.createElement('div');
            primary.className = 'item-primary';

            const keySpan = document.createElement('span');
            keySpan.className = 'key-text';
            keySpan.id = 'pk-' + k.id;
            keySpan.textContent = String(k.key ?? '');

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn-icon';
            toggleBtn.title = '\u67E5\u770B\u5B8C\u6574\u5BC6\u94A5';
            toggleBtn.addEventListener('click', () => toggleProxyKeyVisibility(k.id));

            const svgNs = 'http://www.w3.org/2000/svg';

            const eyeIcon = document.createElementNS(svgNs, 'svg');
            eyeIcon.id = 'pk-eye-' + k.id;
            eyeIcon.setAttribute('xmlns', svgNs);
            eyeIcon.setAttribute('width', '12');
            eyeIcon.setAttribute('height', '12');
            eyeIcon.setAttribute('viewBox', '0 0 24 24');
            eyeIcon.setAttribute('fill', 'none');
            eyeIcon.setAttribute('stroke', 'currentColor');
            eyeIcon.setAttribute('stroke-width', '2');

            const eyePath = document.createElementNS(svgNs, 'path');
            eyePath.setAttribute('d', 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z');

            const eyeCircle = document.createElementNS(svgNs, 'circle');
            eyeCircle.setAttribute('cx', '12');
            eyeCircle.setAttribute('cy', '12');
            eyeCircle.setAttribute('r', '3');

            eyeIcon.appendChild(eyePath);
            eyeIcon.appendChild(eyeCircle);

            const eyeOffIcon = document.createElementNS(svgNs, 'svg');
            eyeOffIcon.id = 'pk-eye-off-' + k.id;
            eyeOffIcon.setAttribute('xmlns', svgNs);
            eyeOffIcon.setAttribute('width', '12');
            eyeOffIcon.setAttribute('height', '12');
            eyeOffIcon.setAttribute('viewBox', '0 0 24 24');
            eyeOffIcon.setAttribute('fill', 'none');
            eyeOffIcon.setAttribute('stroke', 'currentColor');
            eyeOffIcon.setAttribute('stroke-width', '2');
            eyeOffIcon.style.display = 'none';

            const eyeOffPath = document.createElementNS(svgNs, 'path');
            eyeOffPath.setAttribute('d', 'M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24');

            const eyeOffLine = document.createElementNS(svgNs, 'line');
            eyeOffLine.setAttribute('x1', '1');
            eyeOffLine.setAttribute('y1', '1');
            eyeOffLine.setAttribute('x2', '23');
            eyeOffLine.setAttribute('y2', '23');

            eyeOffIcon.appendChild(eyeOffPath);
            eyeOffIcon.appendChild(eyeOffLine);

            toggleBtn.appendChild(eyeIcon);
            toggleBtn.appendChild(eyeOffIcon);

            primary.appendChild(keySpan);
            primary.appendChild(toggleBtn);

            const secondary = document.createElement('div');
            secondary.className = 'item-secondary';
            secondary.textContent = String(k.name ?? '') + ' \xB7 \u5DF2\u4F7F\u7528 ' + String(k.useCount ?? 0) + ' \u6B21';

            info.appendChild(primary);
            info.appendChild(secondary);

            const actions = document.createElement('div');
            actions.className = 'item-actions';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-outline';
            copyBtn.textContent = '\u590D\u5236';
            copyBtn.addEventListener('click', () => copyProxyKey(k.id));

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.textContent = '\u5220\u9664';
            deleteBtn.addEventListener('click', () => deleteProxyKey(k.id));

            actions.appendChild(copyBtn);
            actions.appendChild(deleteBtn);

            item.appendChild(info);
            item.appendChild(actions);

            container.appendChild(item);
          }
        } else {
          container.textContent = '';
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = '\u6682\u65E0\u4EE3\u7406\u5BC6\u94A5\uFF0CAPI \u5F53\u524D\u4E3A\u516C\u5F00\u8BBF\u95EE';
          container.appendChild(empty);
        }
      } catch (e) { showNotification('\u52A0\u8F7D\u5931\u8D25: ' + formatClientError(e), 'error'); }
    }

    async function createProxyKey() {
      const name = document.getElementById('proxyKeyName').value.trim();
      try {
        const res = await fetch('/api/proxy-keys', { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u521B\u5EFA\u5931\u8D25', 'error');
          return;
        }

        showNotification('\u5BC6\u94A5\u5DF2\u521B\u5EFA\uFF0C\u8BF7\u7ACB\u5373\u590D\u5236\u4FDD\u5B58');
        document.getElementById('proxyKeyName').value = '';
        loadProxyKeys();
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    async function deleteProxyKey(id) {
      if (!confirm('\u5220\u9664\u6B64\u5BC6\u94A5\uFF1F\u4F7F\u7528\u6B64\u5BC6\u94A5\u7684\u5BA2\u6237\u7AEF\u5C06\u65E0\u6CD5\u8BBF\u95EE')) return;
      try {
        const res = await fetch('/api/proxy-keys/' + id, { method: 'DELETE', headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u5220\u9664\u5931\u8D25', 'error');
          return;
        }
        showNotification('\u5BC6\u94A5\u5DF2\u5220\u9664');
        loadProxyKeys();
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    const proxyKeyFullValues = {};
    async function toggleProxyKeyVisibility(id) {
      const keySpan = document.getElementById('pk-' + id);
      const eyeIcon = document.getElementById('pk-eye-' + id);
      const eyeOffIcon = document.getElementById('pk-eye-off-' + id);
      if (eyeIcon.style.display !== 'none') {
        if (!proxyKeyFullValues[id]) {
          try {
            const res = await fetch('/api/proxy-keys/' + id + '/export', { headers: getAuthHeaders() });
            const data = await res.json().catch(() => ({}));
            if (handleUnauthorized(res)) return;
            if (res.ok && data.key) proxyKeyFullValues[id] = data.key;
          } catch (e) { return; }
        }
        if (proxyKeyFullValues[id]) {
          keySpan.textContent = proxyKeyFullValues[id];
          eyeIcon.style.display = 'none';
          eyeOffIcon.style.display = 'inline';
        }
      } else { loadProxyKeys(); }
    }

    async function copyProxyKey(id) {
      try {
        const res = await fetch('/api/proxy-keys/' + id + '/export', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u590D\u5236\u5931\u8D25', 'error');
          return;
        }
        if (data.key) { await navigator.clipboard.writeText(data.key); showNotification('\u5BC6\u94A5\u5DF2\u590D\u5236'); }
        else showNotification('\u590D\u5236\u5931\u8D25', 'error');
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    // API \u5BC6\u94A5\u7BA1\u7406
    async function addSingleKey() {
      const key = document.getElementById('singleKey').value.trim();
      if (!key) { showNotification('\u8BF7\u8F93\u5165\u5BC6\u94A5', 'error'); return; }
      try {
        const res = await fetch('/api/keys', { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ key }) });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u6DFB\u52A0\u5931\u8D25', 'error');
          return;
        }
        showNotification('\u5BC6\u94A5\u5DF2\u6DFB\u52A0');
        document.getElementById('singleKey').value = '';
        loadKeys();
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    async function addBatchKeys() {
      const input = document.getElementById('batchKeys').value.trim();
      if (!input) { showNotification('\u8BF7\u8F93\u5165\u5BC6\u94A5', 'error'); return; }
      try {
        const res = await fetch('/api/keys/batch', { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ input }) });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u5BFC\u5165\u5931\u8D25', 'error');
          return;
        }
        if (data.summary) { showNotification(\`\u5BFC\u5165\u5B8C\u6210\uFF1A\${data.summary.success} \u6210\u529F\uFF0C\${data.summary.failed} \u5931\u8D25\`); document.getElementById('batchKeys').value = ''; loadKeys(); }
        else showNotification('\u5BFC\u5165\u5931\u8D25', 'error');
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    async function loadKeys() {
      try {
        const res = await fetch('/api/keys', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u52A0\u8F7D\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }

        const container = document.getElementById('keysContainer');
        if (data.keys?.length > 0) {
          container.textContent = '';

          for (const k of data.keys) {
            const item = document.createElement('div');
            item.className = 'list-item';

            const info = document.createElement('div');
            info.className = 'item-info';

            const primary = document.createElement('div');
            primary.className = 'item-primary';

            const keySpan = document.createElement('span');
            keySpan.className = 'key-text';
            keySpan.id = 'key-' + k.id;
            keySpan.textContent = String(k.key ?? '');

            const keyActions = document.createElement('span');
            keyActions.className = 'key-actions';

            const svgNs = 'http://www.w3.org/2000/svg';

            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn-icon';
            toggleBtn.title = '\u67E5\u770B\u5B8C\u6574\u5BC6\u94A5';
            toggleBtn.addEventListener('click', () => toggleKeyVisibility(k.id));

            const eyeIcon = document.createElementNS(svgNs, 'svg');
            eyeIcon.id = 'eye-' + k.id;
            eyeIcon.setAttribute('xmlns', svgNs);
            eyeIcon.setAttribute('width', '14');
            eyeIcon.setAttribute('height', '14');
            eyeIcon.setAttribute('viewBox', '0 0 24 24');
            eyeIcon.setAttribute('fill', 'none');
            eyeIcon.setAttribute('stroke', 'currentColor');
            eyeIcon.setAttribute('stroke-width', '2');

            const eyePath = document.createElementNS(svgNs, 'path');
            eyePath.setAttribute('d', 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z');

            const eyeCircle = document.createElementNS(svgNs, 'circle');
            eyeCircle.setAttribute('cx', '12');
            eyeCircle.setAttribute('cy', '12');
            eyeCircle.setAttribute('r', '3');

            eyeIcon.appendChild(eyePath);
            eyeIcon.appendChild(eyeCircle);

            const eyeOffIcon = document.createElementNS(svgNs, 'svg');
            eyeOffIcon.id = 'eye-off-' + k.id;
            eyeOffIcon.setAttribute('xmlns', svgNs);
            eyeOffIcon.setAttribute('width', '14');
            eyeOffIcon.setAttribute('height', '14');
            eyeOffIcon.setAttribute('viewBox', '0 0 24 24');
            eyeOffIcon.setAttribute('fill', 'none');
            eyeOffIcon.setAttribute('stroke', 'currentColor');
            eyeOffIcon.setAttribute('stroke-width', '2');
            eyeOffIcon.style.display = 'none';

            const eyeOffPath = document.createElementNS(svgNs, 'path');
            eyeOffPath.setAttribute('d', 'M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24');

            const eyeOffLine = document.createElementNS(svgNs, 'line');
            eyeOffLine.setAttribute('x1', '1');
            eyeOffLine.setAttribute('y1', '1');
            eyeOffLine.setAttribute('x2', '23');
            eyeOffLine.setAttribute('y2', '23');

            eyeOffIcon.appendChild(eyeOffPath);
            eyeOffIcon.appendChild(eyeOffLine);

            toggleBtn.appendChild(eyeIcon);
            toggleBtn.appendChild(eyeOffIcon);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn-icon';
            copyBtn.title = '\u590D\u5236\u5BC6\u94A5';
            copyBtn.addEventListener('click', () => copyKey(k.id));

            const copySvg = document.createElementNS(svgNs, 'svg');
            copySvg.setAttribute('xmlns', svgNs);
            copySvg.setAttribute('width', '14');
            copySvg.setAttribute('height', '14');
            copySvg.setAttribute('viewBox', '0 0 24 24');
            copySvg.setAttribute('fill', 'none');
            copySvg.setAttribute('stroke', 'currentColor');
            copySvg.setAttribute('stroke-width', '2');

            const copyRect = document.createElementNS(svgNs, 'rect');
            copyRect.setAttribute('x', '9');
            copyRect.setAttribute('y', '9');
            copyRect.setAttribute('width', '13');
            copyRect.setAttribute('height', '13');
            copyRect.setAttribute('rx', '2');
            copyRect.setAttribute('ry', '2');

            const copyPath = document.createElementNS(svgNs, 'path');
            copyPath.setAttribute('d', 'M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1');

            copySvg.appendChild(copyRect);
            copySvg.appendChild(copyPath);
            copyBtn.appendChild(copySvg);

            keyActions.appendChild(toggleBtn);
            keyActions.appendChild(copyBtn);

            primary.appendChild(keySpan);
            primary.appendChild(keyActions);

            const secondary = document.createElement('div');
            secondary.className = 'item-secondary';

            const statusBadge = document.createElement('span');
            statusBadge.className = 'status-badge status-' + String(k.status ?? '');
            statusBadge.textContent = String(k.status ?? '');

            secondary.appendChild(statusBadge);
            secondary.appendChild(document.createTextNode(' \xB7 \u5DF2\u4F7F\u7528 ' + String(k.useCount ?? 0) + ' \u6B21'));

            info.appendChild(primary);
            info.appendChild(secondary);

            const actions = document.createElement('div');
            actions.className = 'item-actions';

            const testBtn = document.createElement('button');
            testBtn.className = 'btn btn-success';
            testBtn.textContent = '\u6D4B\u8BD5';
            testBtn.addEventListener('click', () => testKey(k.id, testBtn));

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.textContent = '\u5220\u9664';
            deleteBtn.addEventListener('click', () => deleteKey(k.id));

            actions.appendChild(testBtn);
            actions.appendChild(deleteBtn);

            item.appendChild(info);
            item.appendChild(actions);

            container.appendChild(item);
          }
        } else {
          container.textContent = '';
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = '\u6682\u65E0 API \u5BC6\u94A5';
          container.appendChild(empty);
        }
      } catch (e) { showNotification('\u52A0\u8F7D\u5931\u8D25: ' + formatClientError(e), 'error'); }
    }

    async function copyKey(id) {
      try {
        const res = await fetch('/api/keys/' + id + '/export', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u590D\u5236\u5931\u8D25', 'error');
          return;
        }
        if (data.key) {
          await navigator.clipboard.writeText(data.key);
          showNotification('\u5BC6\u94A5\u5DF2\u590D\u5236');
        } else {
          showNotification('\u590D\u5236\u5931\u8D25', 'error');
        }
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    const keyFullValues = {};
    async function toggleKeyVisibility(id) {
      const keySpan = document.getElementById('key-' + id);
      const eyeIcon = document.getElementById('eye-' + id);
      const eyeOffIcon = document.getElementById('eye-off-' + id);
      if (eyeIcon.style.display !== 'none') {
        if (!keyFullValues[id]) {
          try {
            const res = await fetch('/api/keys/' + id + '/export', { headers: getAuthHeaders() });
            const data = await res.json().catch(() => ({}));
            if (handleUnauthorized(res)) return;
            if (res.ok && data.key) keyFullValues[id] = data.key;
          } catch (e) { return; }
        }
        if (keyFullValues[id]) { keySpan.textContent = keyFullValues[id]; eyeIcon.style.display = 'none'; eyeOffIcon.style.display = 'inline'; }
      } else { loadKeys(); }
    }

    async function deleteKey(id) {
      if (!confirm('\u5220\u9664\u6B64\u5BC6\u94A5\uFF1F')) return;
      try {
        const res = await fetch('/api/keys/' + id, { method: 'DELETE', headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u5220\u9664\u5931\u8D25', 'error');
          return;
        }
        showNotification('\u5BC6\u94A5\u5DF2\u5220\u9664');
        loadKeys();
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    async function testKey(id, btn) {
      setButtonLoading(btn, true, '\u5728\u6D4B');
      try {
        const { res, data } = await fetchJsonWithTimeout('/api/keys/' + id + '/test', { method: 'POST', headers: getAuthHeaders() }, 15000);
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u5BC6\u94A5\u6D4B\u8BD5\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }

        if (data.success) {
          showNotification('\u5BC6\u94A5\u6709\u6548', 'success');
        } else {
          const detail = data.error || data.status || (res.ok ? '' : ('HTTP ' + res.status));
          if (data.status === 'invalid') showNotification('\u5BC6\u94A5\u5931\u6548: ' + detail, 'error');
          else showNotification('\u5BC6\u94A5\u4E0D\u53EF\u7528: ' + detail, 'error');
        }
        loadKeys();
      } catch (e) {
        showNotification('\u5BC6\u94A5\u6D4B\u8BD5\u5931\u8D25: ' + formatClientError(e), 'error');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    async function exportAllKeys() {
      try {
        const res = await fetch('/api/keys/export', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u5BFC\u51FA\u5931\u8D25', 'error');
          return;
        }
        if (data.keys?.length > 0) { await navigator.clipboard.writeText(data.keys.join('\\n')); showNotification(\`\${data.keys.length} \u4E2A\u5BC6\u94A5\u5DF2\u590D\u5236\`); }
        else showNotification('\u6CA1\u6709\u5BC6\u94A5\u53EF\u5BFC\u51FA', 'error');
      } catch (e) { showNotification('\u9519\u8BEF: ' + formatClientError(e), 'error'); }
    }

    // \u6A21\u578B\u7BA1\u7406
    function formatTimestamp(ms) {
      try { return new Date(ms).toLocaleString(); } catch { return String(ms); }
    }

    function renderModelCatalog() {
      const container = document.getElementById('modelCatalogContainer');
      const hint = document.getElementById('modelCatalogHint');
      if (!container || !hint) return;

      const pool = Array.isArray(currentModelPool) ? currentModelPool.map(m => String(m)) : [];
      const poolSet = new Set(pool);

      const catalogModels = (modelCatalogState && Array.isArray(modelCatalogState.models))
        ? modelCatalogState.models.map(m => String(m))
        : [];
      const catalogSet = new Set(catalogModels);

      container.textContent = '';

      if (!modelCatalogState) {
        hint.textContent = '\u672A\u52A0\u8F7D\u6A21\u578B\u76EE\u5F55';
      } else {
        const fetchedAt = modelCatalogState.fetchedAt ? formatTimestamp(modelCatalogState.fetchedAt) : '';
        const stale = modelCatalogState.stale ? '\uFF1B\u76EE\u5F55\u53EF\u80FD\u8FC7\u65F6' : '';
        const lastError = modelCatalogState.lastError ? ('\uFF1B\u4E0A\u6B21\u9519\u8BEF\uFF1A' + modelCatalogState.lastError) : '';
        hint.textContent = '\u76EE\u5F55\u6A21\u578B\u6570\uFF1A' + String(catalogModels.length) + (fetchedAt ? ('\uFF1B\u66F4\u65B0\u65F6\u95F4\uFF1A' + fetchedAt) : '') + stale + lastError;
      }

      function addCheckboxRow(model, badgeText) {
        const name = String(model || '').trim();
        if (!name) return;

        const item = document.createElement('div');
        item.className = 'list-item';

        const info = document.createElement('div');
        info.className = 'item-info';

        const primary = document.createElement('div');
        primary.className = 'item-primary';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'model-pool-checkbox';
        checkbox.dataset.model = name;
        checkbox.checked = poolSet.has(name);
        checkbox.style.marginRight = '8px';

        const modelSpan = document.createElement('span');
        modelSpan.className = 'key-text';
        modelSpan.textContent = name;

        primary.appendChild(checkbox);
        primary.appendChild(modelSpan);

        if (badgeText) {
          const badge = document.createElement('span');
          badge.className = 'status-badge status-inactive';
          badge.textContent = badgeText;
          primary.appendChild(badge);
        }

        info.appendChild(primary);
        item.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const encodedName = encodeURIComponent(name);

        const testBtn = document.createElement('button');
        testBtn.className = 'btn btn-success';
        testBtn.textContent = '\u6D4B\u8BD5';
        testBtn.addEventListener('click', () => testModel(encodedName, testBtn));

        actions.appendChild(testBtn);
        item.appendChild(actions);

        container.appendChild(item);
      }

      const extras = pool.filter((m) => !catalogSet.has(m));
      if (extras.length > 0) {
        const title = document.createElement('div');
        title.className = 'section-title';
        title.textContent = '\u4E0D\u5728\u76EE\u5F55';
        container.appendChild(title);
        for (const m of extras) addCheckboxRow(m, '\u5DF2\u9009');

        const divider = document.createElement('div');
        divider.className = 'divider';
        container.appendChild(divider);
      }

      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = '\u76EE\u5F55\u6A21\u578B';
      container.appendChild(title);

      if (catalogModels.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'empty-state';
        empty.textContent = '\u76EE\u5F55\u4E3A\u7A7A\uFF08\u53EF\u80FD\u662F\u7F51\u7EDC\u95EE\u9898\u6216\u4E0A\u6E38\u53D8\u66F4\uFF09';
        container.appendChild(empty);
        return;
      }

      for (const m of catalogModels) {
        addCheckboxRow(m, '');
      }
    }

    async function loadModelCatalog() {
      try {
        const res = await fetch('/api/models/catalog', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u52A0\u8F7D\u6A21\u578B\u76EE\u5F55\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }
        modelCatalogState = data;
        renderModelCatalog();
      } catch (e) {
        showNotification('\u52A0\u8F7D\u6A21\u578B\u76EE\u5F55\u5931\u8D25: ' + formatClientError(e), 'error');
      }
    }

    async function refreshModelCatalog() {
      const btn = document.getElementById('refreshModelCatalogBtn');
      setButtonLoading(btn, true, '\u5237\u65B0\u4E2D...');
      try {
        const { res, data } = await fetchJsonWithTimeout('/api/models/catalog/refresh', { method: 'POST', headers: getAuthHeaders() }, 15000);
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u5237\u65B0\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }
        modelCatalogState = data;
        showNotification('\u76EE\u5F55\u5DF2\u5237\u65B0');
        renderModelCatalog();
      } catch (e) {
        showNotification('\u5237\u65B0\u5931\u8D25: ' + formatClientError(e), 'error');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    async function saveModelPoolFromSelection() {
      const btn = document.getElementById('saveModelPoolBtn');
      setButtonLoading(btn, true, '\u4FDD\u5B58\u4E2D...');

      try {
        const nodes = document.querySelectorAll('.model-pool-checkbox');
        const models = [];
        const seen = new Set();

        for (const el of nodes) {
          if (!el || el.type !== 'checkbox') continue;
          if (!el.checked) continue;
          const m = String(el.dataset.model || '').trim();
          if (!m || seen.has(m)) continue;
          seen.add(m);
          models.push(m);
        }

        if (models.length === 0) {
          showNotification('\u6A21\u578B\u6C60\u4E0D\u80FD\u4E3A\u7A7A', 'error');
          return;
        }

        const res = await fetch('/api/models', {
          method: 'PUT',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ models }),
        });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification(getApiErrorMessage(res, data) || '\u4FDD\u5B58\u5931\u8D25', 'error');
          return;
        }

        showNotification('\u6A21\u578B\u6C60\u5DF2\u4FDD\u5B58');
        loadModels();
      } catch (e) {
        showNotification('\u4FDD\u5B58\u5931\u8D25: ' + formatClientError(e), 'error');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    async function loadModels() {
      try {
        const res = await fetch('/api/models', { headers: getAuthHeaders() });
        const data = await res.json().catch(() => ({}));
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u52A0\u8F7D\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }

        currentModelPool = Array.isArray(data.models) ? data.models.map(m => String(m)) : [];
        renderModelCatalog();
      } catch (e) {
        showNotification('\u52A0\u8F7D\u5931\u8D25: ' + formatClientError(e), 'error');
      }
    }

    async function testModel(name, btn) {
      setButtonLoading(btn, true, '\u5728\u6D4B');
      try {
        const { res, data } = await fetchJsonWithTimeout('/api/models/' + name + '/test', { method: 'POST', headers: getAuthHeaders() }, 15000);
        if (handleUnauthorized(res)) return;
        if (!res.ok) {
          showNotification('\u6A21\u578B\u6D4B\u8BD5\u5931\u8D25: ' + getApiErrorMessage(res, data), 'error');
          return;
        }
        const ok = Boolean(data.success);
        const detail = data.error || data.status || (res.ok ? '' : ('HTTP ' + res.status));
        showNotification(ok ? '\u6A21\u578B\u53EF\u7528' : ('\u6A21\u578B\u4E0D\u53EF\u7528: ' + detail), ok ? 'success' : 'error');
      } catch (e) {
        showNotification('\u6A21\u578B\u6D4B\u8BD5\u5931\u8D25: ' + formatClientError(e), 'error');
      } finally {
        setButtonLoading(btn, false);
      }
    }

    checkAuth();
  <\/script>
</body>
</html>`;return new Response(a,{headers:{..._,"Content-Type":"text/html"}})}async function Te(e){let o=new URL(e.url).pathname;if(e.method==="OPTIONS")return new Response(null,{status:204,headers:K});if(o.startsWith("/api/auth/")){let n=await fe(e,o);return n||d("Not Found",{status:404,instance:o})}if(o.startsWith("/api/")){if(!await Qt(e))return d("\u672A\u767B\u5F55",{status:401,instance:o});let n=await ye(e,o);if(n)return n;let r=await me(e,o);if(r)return r;let a=await pe(e,o);if(a)return a;let s=await he(e,o);return s||d("Not Found",{status:404,instance:o})}return e.method==="GET"&&o==="/v1/models"?ge(e):e.method==="POST"&&o==="/v1/chat/completions"?await be(e):o==="/"&&e.method==="GET"?await Tt():new Response("Not Found",{status:404})}console.log("Cerebras Proxy \u542F\u52A8");console.log("- \u7BA1\u7406\u9762\u677F: /");console.log("- API \u4EE3\u7406: /v1/chat/completions");console.log("- \u6A21\u578B\u63A5\u53E3: /v1/models");console.log("- \u5B58\u50A8: Deno KV");import.meta.main&&(await ie(),ft(g),Pt(Te));
